<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PTSP</title>
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" />
    <style>
      :root {
          --primary-color: #ff4757;
          --secondary-color: #ff6b81;
          --dark-bg: rgba(0, 0, 0, 0.8);
          --text-light: #fff;
          --transition-timing: 0.3s ease;
      }

      {% for style_num, colors in STYLE_CONFIG.items() %}
      .style-{{ style_num }} {
          --primary-color: {{ colors['primary'] }};
          --secondary-color: {{ colors['secondary'] }};
      }
      {% endfor %}

      body {
          font-family: 'Segoe UI', system-ui, sans-serif;
          background: linear-gradient(135deg, #ff9a9e 0%, #fad0c4 100%);
          color: var(--text-light);
          margin: 0;
          min-height: 100vh;
          display: flex;
          flex-direction: column;
          justify-content: center;
          padding: 20px;
      }

      #initModal {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.9);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 1000;
      }

      .modal-content {
          background: var(--dark-bg);
          padding: 2rem;
          border-radius: 15px;
          width: 90%;
          max-width: 400px;
          animation: modalEntry 0.4s ease-out forwards;
      }

      @keyframes modalEntry {
          from { transform: scale(0.9); opacity: 0; }
          to { transform: scale(1); opacity: 1; }
      }

      .modal-input-group {
          margin: 1.5rem 0;
      }

      .modal-input {
          width: 100%;
          padding: 12px;
          margin: 8px 0;
          background: rgba(255, 255, 255, 0.1);
          border: 1px solid rgba(255, 255, 255, 0.2);
          border-radius: 8px;
          color: var(--text-light);
          font-size: 1rem;
          transition: all var(--transition-timing);
      }

      .modal-input:focus {
          outline: none;
          border-color: var(--primary-color);
          box-shadow: 0 0 10px rgba(255, 71, 87, 0.3);
      }

      .container {
          max-width: 800px;
          width: 90%;
          margin: 20px auto;
          background: var(--dark-bg);
          padding: 2.5rem;
          border-radius: 20px;
          box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
          backdrop-filter: blur(10px);
      }

      .user-info {
          background: rgba(255, 255, 255, 0.1);
          padding: 1rem;
          border-radius: 8px;
          margin-bottom: 2rem;
      }

      .user-info p {
          margin: 0.5rem 0;
          font-size: 1.1rem;
      }

      h1 {
          font-size: 2.5rem;
          margin-bottom: 1.5rem;
          font-weight: 300;
          letter-spacing: 1px;
          text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
      }

      .controls {
          display: flex;
          flex-direction: column;
          align-items: center;
          gap: 1.2rem;
          margin: 2rem 0;
      }

      select {
          width: 100%;
          max-width: 400px;
          padding: 12px 20px;
          font-size: 1.1rem;
          border: none;
          border-radius: 8px;
          background: rgba(255, 255, 255, 0.95);
          color: #333;
          appearance: none;
          cursor: pointer;
      }

      button {
          padding: 14px 28px;
          font-size: 1.1rem;
          background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
          color: var(--text-light);
          border: none;
          border-radius: 8px;
          cursor: pointer;
          transition: all 0.3s ease;
          text-transform: uppercase;
          letter-spacing: 1px;
          font-weight: 600;
      }

      button:hover {
          transform: translateY(-2px);
          box-shadow: 0 5px 20px rgba(255, 75, 75, 0.4);
      }

      #plot {
          margin: 2rem auto;
          max-width: 600px;
      }

      #plotImage {
          width: 100%;
          height: auto;
          border-radius: 12px;
          border: 3px solid rgba(255, 255, 255, 0.1);
          box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
      }

      #statusMessage {
          margin: 1.5rem 0;
          color: #ffd700;
          min-height: 24px;
      }

      .loading-spinner {
          display: none;
          width: 40px;
          height: 40px;
          margin: 20px auto;
          border: 4px solid #f3f3f3;
          border-top: 4px solid var(--primary-color);
          border-radius: 50%;
          animation: spin 1s linear infinite;
      }

      @keyframes spin {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
      }

      @media (max-width: 600px) {
          .container {
              padding: 1.5rem;
          }
          h1 {
              font-size: 2rem;
          }
          button {
              width: 100%;
          }
      }
    </style>
  </head>
  <body class="{% if not show_modal %}{{ style_class }}{% endif %}">
    <div
      id="initModal"
      {%
      if
      not
      show_modal
      %}style="display: none;"
      {%
      endif
      %}
    >
      <div class="modal-content">
        <h2>Welcome to Distribution Plotter</h2>
        <form id="userConfigForm">
          <div class="modal-input-group">
            <input
              type="text"
              class="modal-input"
              id="userName"
              placeholder="Your Name"
              required
            />
            <input
              type="text"
              class="modal-input"
              id="userRoll"
              placeholder="Roll Number"
              required
            />
            <input
              type="number"
              class="modal-input"
              id="styleNumber"
              placeholder="Style Number (0-10)"
              min="0"
              max="10"
              required
            />
          </div>
          <button type="submit" class="modal-submit">Start Plotting</button>
        </form>
      </div>
    </div>

    <div
      class="container"
      {%
      if
      show_modal
      %}style="display: none;"
      {%
      endif
      %}
    >
      <h1>PTSP Assignment: Smart Distribution Plotter</h1>
      <div class="user-info">
        <p>
          ðŸ‘¤ Name:
          <span id="userNameDisplay">{{ user.name if user else 'Guest' }}</span>
        </p>
        <p>
          ðŸŽ« Roll No:
          <span id="userRollDisplay"
            >{{ user.roll_no if user else 'N/A' }}</span
          >
        </p>
        <p>
          ðŸŽ¨ Style:
          <span id="styleDisplay">{{ user.style if user else 'Default' }}</span>
        </p>
      </div>

      <form id="distributionForm" class="controls">
        <select id="distribution">
          <option value="uniform">Uniform</option>
          <option value="rayleigh">Rayleigh</option>
          <option value="binomial">Binomial</option>
          <option value="poisson">Poisson</option>
          <option value="laplacian">Laplacian</option>
          <option value="gaussian">Gaussian</option>
        </select>
        <div class="button-group">
          <button type="submit">Generate Plot</button>
          <button type="button" onclick="listenAndPlot()">
            ðŸŽ¤ Voice Command
          </button>
        </div>
      </form>

      <div id="statusMessage"></div>
      <div class="loading-spinner"></div>
      <div id="plot">
        <img id="plotImage" src="" alt="Distribution Plot" />
      </div>
    </div>

    <script>
      const spinner = document.querySelector(".loading-spinner");
      const statusMessage = document.getElementById("statusMessage");

      const showLoading = () => {
        spinner.style.display = "block";
        statusMessage.textContent = "Processing...";
      };

      const hideLoading = () => {
        spinner.style.display = "none";
        statusMessage.textContent = "";
      };

      // Handle configuration form
      document
        .getElementById("userConfigForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();
          const userData = {
            name: document.getElementById("userName").value.trim(),
            roll_no: document.getElementById("userRoll").value.trim(),
            style: parseInt(document.getElementById("styleNumber").value),
          };

          if (!userData.name || !userData.roll_no || isNaN(userData.style)) {
            alert("Please fill all fields correctly");
            return;
          }

          showLoading();
          fetch("/save_config", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(userData),
          })
            .then((response) => {
              if (!response.ok) throw new Error("Failed to save config");
              return response.json();
            })
            .then(() => {
              document.getElementById("initModal").style.display = "none";
              document.querySelector(".container").style.display = "block";
              document.body.classList.add(`style-${userData.style}`);
              document.getElementById("userNameDisplay").textContent =
                userData.name;
              document.getElementById("userRollDisplay").textContent =
                userData.roll_no;
              document.getElementById("styleDisplay").textContent =
                userData.style;
            })
            .catch((error) => {
              alert(error.message);
            })
            .finally(() => hideLoading());
        });

      // Handle plot generation
      document
        .getElementById("distributionForm")
        .addEventListener("submit", function (e) {
          e.preventDefault();
          showLoading();
          const distribution = document.getElementById("distribution").value;

          fetch("/get_pdf", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ distribution }),
          })
            .then((response) => {
              if (!response.ok) throw new Error("Plot generation failed");
              return response.json();
            })
            .then((data) => {
              document.getElementById(
                "plotImage"
              ).src = `data:image/png;base64,${data.image}`;
            })
            .catch((error) => {
              statusMessage.textContent = error.message;
            })
            .finally(() => hideLoading());
        });

      // Handle voice commands
      async function listenAndPlot() {
        showLoading();
        try {
          const response = await fetch("/speech_to_pdf", { method: "POST" });
          if (!response.ok) throw new Error("Voice command failed");

          const data = await response.json();
          document.getElementById(
            "plotImage"
          ).src = `data:image/png;base64,${data.image}`;
          if (data.distribution) {
            document.getElementById("distribution").value = data.distribution;
          }
        } catch (error) {
          statusMessage.textContent = error.message;
        }
        hideLoading();
      }
    </script>
  </body>
</html>
